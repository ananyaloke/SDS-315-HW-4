---
title: "SDS 315 HW 3"
author: "Ananya Loke - UT EID: asl3324"
date: "2025-01-27"
output: 
  pdf_document:
    includes:
      toc: true
---


Click [here](https://github.com/ananyaloke/SDS-315-HW-3/) for the Github link to the code!


```{r global_options, echo=FALSE}
knitr::opts_chunk$set(fig.height=6, fig.width=8, warning=FALSE, message = FALSE, tidy=TRUE, echo=FALSE, tidy.opts=list(width.cutoff=60))
```


```{r, echo = FALSE, include=FALSE}
#loading libraries
library(tidyverse)
library(lubridate)
library(kableExtra)
library(rvest)
library(RColorBrewer)
library(mosaic)


#reading in libraries
let_freq = read_csv("letter_frequencies.csv")



```


# **Problem 1: Iron Bank**


```{r}

set.seed(555)

sim_flagged = do(100000)*nflip(n=2021, prob=0.024)

ggplot(sim_flagged) +   
  geom_histogram(data = subset(sim_flagged, nflip > 70), 
                 aes(x = nflip), binwidth = 1, 
                 col = "purple3", fill = "lightslateblue") +
  geom_histogram(data = subset(sim_flagged, nflip <= 70), 
                 aes(x = nflip), binwidth = 1, 
                 col = "firebrick4", fill = "lightpink") +
  geom_vline(xintercept = 70, linetype = "longdash", col = "black") +
  theme_classic()



p_val1 = sum(sim_flagged >= 70)/100000





```
 

#### Null Hypothesis: The probability of a legal trade being flagged by the SEC's detection algorithm is 2.4%. 
#### Test Statistic: Of the last 2021 trades by Iron Bank employees, 70 were flagged by the SEC’s detection algorithm. 
#### P-Value: `r p_val1`
#### Conclusion: The p-value found is below 0.01 which means that, while not entirely impossible, 70 out of 2021 trades being flagged is not the same 2.4% baseline rate as that of other traders. With this low of a p-value, we can reject the null hypothesis.  




# **Problem 2: Health Inspections**


```{r}
set.seed(555)

sim_inspect = do(100000)*nflip(n=50, prob=0.03)

ggplot(sim_inspect) +   
  geom_histogram(data = subset(sim_flagged, nflip >= 8), 
                 aes(x = nflip), binwidth = 1, 
                 col = "firebrick4", fill = "lightpink") +
  geom_histogram(data = subset(sim_flagged, nflip < 8), 
                 aes(x = nflip), binwidth = 1, 
                 col = "purple3", fill = "lightslateblue") +
  geom_vline(xintercept = 8, linetype = "longdash", col = "black") +
  theme_classic()



p_val2 = sum(sim_inspect >= 8)/100000

```


#### Null Hypothesis: On average, 3% of all restaurant inspections result in health code violations due to random issues that can occur even in well-managed establishments. 
#### Test Statistic: Over the last year, Gourmet Bites was inspected a total of 50 times, 8 of which resulted in health code violations being reported. 
#### P-Value: `r p_val2`
#### Conclusion: The p-value is significantly lower than 10^-3 meaning that we can confidently reject the null hypothesis and say that the observed data for Gourmet Bites is not consistent with the Health Department’s statistic that restaurants in the city are cited for health code violations at the same 3% baseline rate.




# **Problem 3: Evaluating Jury Selection for Bias**



```{r}
observed = c(85, 56, 59, 27, 13)
expected = 240 * c(0.30, 0.25, 0.20, 0.15, 0.10)
chi_squared_stat1 = sum((observed - expected)^2 / expected)
p_val3 = pchisq(chi_squared_stat1, df = 4, lower.tail = FALSE)


```

#### For this problem, we can use a chi-square test to analyze whether the distribution of jurors empaneled by this judge is significantly different from the county’s population proportions. Our null hypothesis is that the total number of jurors (240) will be 30% Group 1 (72), 25% Group 2 (60), 20% Group 3 (48), 15% Group 4 (36), and 10% Group 5 (24). Our test statistic is a group of 240 jurors with 85 Group 1 members, 56 Group 2 members, 59 Group 3 members, 27 Group 4 members, and 14 Group 5 members. After calculating, we get a chi squared value of `r chi_squared_stat1` and a p-value of `r p_val3`. While this p-value is below 0.05, raising some questions about if the distribution matches the expected proportions, it is not low enough to confirm a significant difference from the expected proportions. The differences could be explained away with sampling variance (random chance differences in the sampled population) or sampling bias (which area of the county was sampled? did it cover the whole county evenly?). To investigate further, we could repeat the sampling process with blocking and then randomizing. However, since that may be impractical, we could also re-investigate the same sample using bootstrapping to extrapolate the data and come to a more certain conclusion about how the sample distribution compares to the true county’s population proportions.






# **Problem 4: LLM watermarking**

### Part A: The Null or Reference Distribution



```{r}

#read the sentences
sentences = readLines("brown_sentences.txt", warn = FALSE)

english_freq = setNames(let_freq$Probability, let_freq$Letter)  # Convert data frame to named vector


#make a function so we can use for each sentence
process_sentence = function(sentence) {
  #preprocess the text
  sentence = toupper(gsub("[^A-Z]", "", sentence))  # Remove non-letters, convert to uppercase
  sentence_length = nchar(sentence)
  
  #calculate letter count
  observed_counts = table(strsplit(sentence, "")[[1]])
  
  all_letters = setNames(rep(0, length(english_freq)), names(english_freq))
  
  observed_counts = as.numeric(observed_counts)
  names(observed_counts) = names(observed_counts)
  
  all_letters[names(observed_counts)] = observed_counts
  
  #compare with expected count
  expected_counts = sentence_length * english_freq
  
  #compute the chi-squared statistic
  chi_squared = sum((all_letters - expected_counts)^2 / expected_counts, na.rm = TRUE)
  return(chi_squared)
}


#compile the distribution
chi_squared_values = sapply(sentences, process_sentence)

#view the distribution
hist(chi_squared_values, main="Chi-Squared Distribution of Sentences", xlab="Chi-Squared Statistic", breaks=30, col = "lightpink")


```

#### The histogram above shows the distribution of the chi squared statistic for the sentences in the brown_sentences.txt file. 


### Part B: checking for a watermark

```{r, fig.height=5, fig.width=8}

test_sentences <- c(
  "She opened the book and started to read the first chapter, eagerly anticipating what might come next.",
  "Despite the heavy rain, they decided to go for a long walk in the park, crossing the main avenue by the fountain in the center.",
  "The museum’s new exhibit features ancient artifacts from various civilizations around the world.",
  "He carefully examined the document, looking for any clues that might help solve the mystery.",
  "The students gathered in the auditorium to listen to the guest speaker’s inspiring lecture.",
  "Feeling vexed after an arduous and zany day at work, she hoped for a peaceful and quiet evening at home, cozying up after a quick dinner with some TV, or maybe a book on her upcoming visit to Auckland.",
  "The chef demonstrated how to prepare a delicious meal using only locally sourced ingredients, focusing mainly on some excellent dinner recipes from Spain.",
  "They watched the sunset from the hilltop, marveling at the beautiful array of colors in the sky.",
  "The committee reviewed the proposal and provided many points of useful feedback to improve the project’s effectiveness.",
  "Despite the challenges faced during the project, the team worked tirelessly to ensure its successful completion, resulting in a product that exceeded everyone’s expectations."
)

#function for calculating p-value
calculate_p_value <- function(chi_squared_statistic, reference_chi_squared_values) {
  p_value <- mean(reference_chi_squared_values >= chi_squared_statistic)
  return(p_value)
}

test_chi_squared_values <- sapply(test_sentences, process_sentence)

p_values <- sapply(test_chi_squared_values, calculate_p_value, reference_chi_squared_values = chi_squared_values)
p_value_table <- data.frame(Sentence = test_sentences, P_Value = round(p_values, 3))
p_value_table <- data.frame(Sentence = p_value_table$Sentence, P_Value = p_value_table$P_Value)


styled_table <- kbl(p_value_table, col.names = c("Sentence", "P-Value")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left") %>%
  column_spec(1, width = "15cm") %>%
  row_spec(0, bold = TRUE)

# Ensure word wrapping for long text in LaTeX
styled_table



```
#### I believe the sentence produced by an LLM is the following sentence:


"Feeling vexed after an arduous and zany day at work, she hoped for a peaceful and quiet evening at home, cozying up after a quick dinner with some TV, or maybe a book on her upcoming visit to Auckland."


#### This is because the p-value of this sentence is the lowest/farthest from 1 (0.171) which leads me to believe that it was not written by a human as is least follows the “typical” English letter distribution.


